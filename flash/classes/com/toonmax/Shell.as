import mx.utils.Delegate;import com.toonmax.ui.*;import com.koocaa.util.debug.Debugger;class com.toonmax.Shell {	private static var shell:Shell;		private var container_mc:MovieClip;		private var header_mc:Header;	private var nav_mc:MovieClip;	private var bg_grey_mc:MovieClip;	private var bg_v_mc:Bg_v;	private var footer_mc:MovieClip;	private var smg_mc:MovieClip;	private var coverflow_mc:MovieClip;	private var coverflow_height:Number = 385;//302.5;	private var cp_mc:MovieClip;		private var depth:Number = 1;	private var it:Number;		private var timer:Number;	private var slideshow_time:Number = 5000;	private var slideshow_it:Number;		private var aboutus_panel_id:Number;		/*lights_mc*/	private var lights_up_mc:MovieClip;	private var lights_down_mc:MovieClip;		private function Shell(){		Stage.scaleMode = 'noscale';		Stage.align = 'TL'		Stage.addListener(this);	}		public static function getInstance():Shell{		if (shell == null) shell = new Shell();		return shell;	}		public function initUI(timeline:MovieClip){		container_mc = timeline;				bg_grey_mc = container_mc['Bg_grey']; 		bg_v_mc = Bg_v(container_mc['Bg_v']);		nav_mc = container_mc['Nav'];		header_mc = Header(container_mc['Header']);		footer_mc = container_mc['Footer'];		smg_mc = container_mc['smg_logo'];		cp_mc = container_mc['cp_mc'];		coverflow_mc = container_mc['coverflow'];		footer_mc.aboutus_mc.onRelease = Delegate.create(this,showAboutUs);				onResize();				coverflow_mc.addEventListener('ITEM_ON_PRESS', Delegate.create(this,onItemPress));		/*coverflow_mc.addEventListener('ITEM_ON_RELEASE', Delegate.create(this,onItemRelease));*/		coverflow_mc.addEventListener('INITIALIZE', Delegate.create(this,onFlowInitialized));		coverflow_mc.addEventListener('CONTENT_LOAD_PROGRESS',Delegate.create(this,checkLoaded));	}		private function prepareCoverFlow(){		for(var i=0;i<coverflow_mc.getTotalItems();i++){			var data = coverflow_mc.getItemNum(i);			setDesc_mc(i,data);		}	}		private function checkLoaded(evt){		/*Debugger.trace(evt,'checkLoaded');*/		var item_id = evt.itemsLoaded;		/*trace('checkLoaded: '+ coverflow_mc.display_mc['clip-'+(item_id)]);*/		if (coverflow_mc.display_mc['clip-'+(item_id)]){			coverflow_mc.display_mc['clip-'+(item_id)].loaded = true;		}	}		private function onItemPress(evt:Object){		var item_id = evt.itemId;		/*trace('onItemPress: ' + item_id);*/				//if item to show is not current item		if (item_id != coverflow_mc.getSelectedItemNum()){			showDesc(item_id);			header_mc.rotate();			bg_v_mc.rotate();			stopTimer();			if (item_id != aboutus_panel_id) {				startTimer();				//remove aboutus				if (coverflow_mc.getSelectedItemNum()==aboutus_panel_id) {					/*trace('remove aboutus');*/					coverflow_mc.removeItem({id:aboutus_panel_id});				}			}		} else {			trace('click on the current item');			/*Debugger.trace(evt.target);*/			var url = evt.target.data;			if (url != '' && url != null)				getURL(url);		}			}		private function onItemRelease(evt){		trace('onItemRelease');	}		private function showDesc(id){		var current_desc_mc = getDesc_mc(coverflow_mc.getSelectedItemNum());		current_desc_mc.gotoAndPlay('off');				clearInterval(it);		it = setInterval(function(mc,shell){			trace('showDesc: ' + mc._parent._parent.loaded);			if (mc._parent._parent.loaded){				mc._xscale=100;mc.gotoAndPlay('on');clearInterval(shell.it);				shell.lights_up_mc._visible = shell.lights_down_mc._visible = true;			}		},500,getDesc_mc(id),shell);	}		private function checkTimer(){		var cur_timer = getTimer();		/*trace(coverflow_mc);*/		/*trace(cur_timer - timer);*/		if ((cur_timer - timer) > slideshow_time) {			timer = cur_timer;			var next_id = coverflow_mc.getSelectedItemNum()>=coverflow_mc.getTotalItems()-1 ? 0 : coverflow_mc.getSelectedItemNum() + 1;			/*trace("next_id: "+next_id);*/			manaualSelectItem(next_id,0);		}	}		private function onFlowInitialized(){		trace('onFlowInitialized');				prepareCoverFlow();		coverflow_mc.visible = true;		manaualSelectItem(1,800);		aboutus_panel_id = coverflow_mc.getTotalItems();				//startTimer();		/*trace(coverflow_mc._width+'/'+coverflow_mc._height);*/		onResize();				attachLights();	}		private function attachLights(){		var w = 600;		var x = (Stage.width-w)/2;		var up_y = coverflow_mc._y;		var down_y = coverflow_mc._y+coverflow_height;				if (container_mc.up_mc || container_mc.down_mc) {			lights_up_mc._x = x; lights_up_mc._y = up_y; lights_up_mc._width = w;			lights_down_mc._x = x; lights_down_mc._y = down_y; lights_down_mc._width = w;			lights_up_mc._yscale = -100; 		} else {			lights_up_mc = container_mc.attachMovie('lights_mc','up_mc',depth++,{_x:x,_y:up_y,_yscale:-100,_width:w,_visible:false});			lights_down_mc = container_mc.attachMovie('lights_mc','down_mc',depth++,{_x:x,_y:down_y,_width:w,_visible:false});		}			//trace(lights_up_mc._yscale);	}		private function startTimer(){		timer = getTimer();		clearInterval(slideshow_it);		slideshow_it = setInterval(Delegate.create(this,checkTimer),100);		/*trace('slideshow_it: '+slideshow_it);*/		/*slideshow_it = setInterval(checkTimer,this,100);*/	}		private function stopTimer(){		/*trace('stop_id: ' + slideshow_it);*/		clearInterval(slideshow_it);				lights_up_mc._visible = lights_down_mc._visible = false;	}		private function manaualSelectItem(id,delay){		/*trace('manualSelectItem: ' + id + '/' + delay);*/		setTimeout(function(mc){			/*trace('delayed function')*/			/*mc.showDesc(id);*/			mc.onItemPress({itemId:id});			mc.coverflow_mc.selectItemNum(id);			/*trace('selectedItem: ' + mc.coverflow_mc.getSelectedItemNum());*/		},delay,this);	}		private function getDesc_mc(id){		return coverflow_mc.display_mc['clip-'+(id+1)]['moving_mc']['desc_mc'];	}		//coverflow_mc	//	display_mc	//		clip-1	//			loading_clip	//			moving_mc	//				virtualClip_mc	//				desc_mc	private function setDesc_mc(id,d){		var clip_mc = coverflow_mc.display_mc['clip-'+(id+1)]['moving_mc'];		if (!clip_mc['desc_mc']){			clip_mc.attachMovie('desc_mc','desc_mc',3);		}				var desc_mc = clip_mc['desc_mc'];		desc_mc._xscale = 0;		/*desc_mc._visible = false;*/		//desc_mc._y = clip_mc.virtualClip_mc._y;		desc_mc._y = 180;				var data = d.description.split('|');		desc_mc.title = data[0];		desc_mc.desc = data[1];		return desc_mc;	}		private function getSH(){		/*Debugger.trace(container_mc['h']);*/		if (container_mc['h']) return container_mc['h']		else return Stage.height;	}		public function onResize(){		/*trace('onResize');		trace(coverflow_mc._width+'/'+coverflow_mc._height);		trace('header_mc._height: ' + header_mc._height);*/				var sw = Stage.width;		var sh = getSH(); //Stage.height;		coverflow_mc.swapthDepths(100);		header_mc._x = (sw - header_mc.width)/2;		header_mc._y = 0;		bg_v_mc._x = (sw - bg_v_mc._width)/2;		bg_v_mc._height = sh;		bg_v_mc._y = 0;		bg_grey_mc._width = sw;		bg_grey_mc._height = sh;		bg_grey_mc._x = bg_grey_mc._y = 0;		smg_mc._y = 5;		smg_mc._x = sw - 5 - smg_mc._width;		footer_mc._x = sw/2;		footer_mc._y = sh - 20;		cp_mc._y = sh;		cp_mc._x = footer_mc._x;				coverflow_mc._x = (sw-coverflow_mc._width)/2;		/*trace(header_mc._height+'/'+(sh-coverflow_height-footer_mc._height-20)/2);*/		var ty = header_mc._height + (sh-coverflow_height-header_mc._height-footer_mc._height-20)/2;		if (ty < header_mc._height) ty = header_mc._height;		coverflow_mc._y = ty;				/*var nav_x = coverflow_mc._x - nav_mc._width - 20;*/		nav_mc._x = Math.max(coverflow_mc._x - 180,20);		nav_mc._y = (sh-nav_mc._height)/2;				attachLights();				/*		header_mc: 164.5		coverflow_height: 302.5		footer_mc: 46;		footer_mc margin bottom: 20		total usable height = 164.5+302.5+46+20 = 533		*/				if (container_mc['frame_mc']) {			var frame_mc = container_mc['frame_mc'];			frame_mc._alpha = 40;			frame_mc._x = coverflow_mc._x;			frame_mc._y = coverflow_mc._y;		}	}		private function showAboutUs(){		if (coverflow_mc.getTotalItems()<=aboutus_panel_id){			coverflow_mc.addItem({itemId:aboutus_panel_id,						data:'javascript:showOrgChart();',description:"",path:"flash/flowlist/images/aboutus.swf"});		}		manaualSelectItem(aboutus_panel_id,0);		stopTimer();				coverflow_mc.addEventListener('CONTENT_LOAD_PROGRESS',Delegate.create(this,attachAboutUs));	}		private function attachAboutUs(evt){		Debugger.trace(evt,'CONTENT_LOAD_PROGRESS');		trace('aboutus_panel_id: ' + aboutus_panel_id);		var items_loaded = evt.itemsLoaded;		if (aboutus_panel_id > items_loaded-1) return;				var holder_mc = coverflow_mc.display_mc['clip-'+(items_loaded)]['moving_mc'];		trace(holder_mc);		holder_mc.attachMovie('about_us','about_us',10, {_x:-320,_y:-160});		coverflow_mc.removeEventListener('CONTENT_LOAD_PROGRESS',Delegate.create(this,attachAboutUs));	}}